{"version":3,"file":"remix-wizard.js","sourceRoot":"","sources":["../../../src/remix/remix-wizard.ts"],"names":[],"mappings":"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","sourcesContent":["// @ts-expect-error - clack is ESM and TS complains about that. It works though\nimport clack from '@clack/prompts';\nimport chalk from 'chalk';\n\nimport { DEFAULT_URL } from '../../lib/Constants';\nimport { configureVitePlugin } from '../sourcemaps/tools/vite';\nimport { traceStep, withTelemetry } from '../telemetry';\nimport { findFile } from '../utils/ast-utils';\nimport {\n  addSentryCliConfig,\n  askShouldCreateExamplePage,\n  confirmContinueIfNoOrDirtyGitRepo,\n  ensurePackageIsInstalled,\n  featureSelectionPrompt,\n  getOrAskForProjectData,\n  getPackageDotJson,\n  installPackage,\n  isUsingTypeScript,\n  printWelcome,\n  rcCliSetupConfig,\n  runPrettierIfInstalled,\n} from '../utils/clack';\nimport { debug } from '../utils/debug';\nimport { hasPackageInstalled } from '../utils/package-json';\nimport type { WizardOptions } from '../utils/types';\nimport { createExamplePage } from './sdk-example';\nimport {\n  createServerInstrumentationFile,\n  initializeSentryOnEntryClient,\n  insertServerInstrumentationFile,\n  instrumentRootRoute,\n  instrumentSentryOnEntryServer,\n  isRemixV2,\n  loadRemixConfig,\n  runRemixReveal,\n  updateBuildScript,\n  updateStartScript,\n} from './sdk-setup';\nimport { isHydrogenApp } from './utils';\n\nexport async function runRemixWizard(options: WizardOptions): Promise<void> {\n  return withTelemetry(\n    {\n      enabled: options.telemetryEnabled,\n      integration: 'remix',\n      wizardOptions: options,\n    },\n    () => runRemixWizardWithTelemetry(options),\n  );\n}\n\nasync function runRemixWizardWithTelemetry(\n  options: WizardOptions,\n): Promise<void> {\n  const { promoCode, telemetryEnabled, forceInstall } = options;\n\n  printWelcome({\n    wizardName: 'Sentry Remix Wizard',\n    promoCode,\n    telemetryEnabled,\n  });\n\n  await confirmContinueIfNoOrDirtyGitRepo({\n    ignoreGitChanges: options.ignoreGitChanges,\n    cwd: undefined,\n  });\n\n  const remixConfig = await loadRemixConfig();\n  const packageJson = await getPackageDotJson();\n\n  // We expect `@remix-run/dev` to be installed for every Remix project\n  await ensurePackageIsInstalled(packageJson, '@remix-run/dev', 'Remix');\n\n  const { selectedProject, authToken, sentryUrl, selfHosted } =\n    await getOrAskForProjectData(options, 'javascript-remix');\n\n  await installPackage({\n    packageName: '@sentry/remix@^9',\n    packageNameDisplayLabel: '@sentry/remix',\n    alreadyInstalled: hasPackageInstalled('@sentry/remix', packageJson),\n    forceInstall,\n  });\n\n  const dsn = selectedProject.keys[0].dsn.public;\n\n  const isTS = isUsingTypeScript();\n  const isV2 = isRemixV2(remixConfig, packageJson);\n  const viteConfig = findFile('vite.config');\n  const selectedFeatures = await featureSelectionPrompt([\n    {\n      id: 'performance',\n      prompt: `Do you want to enable ${chalk.bold(\n        'Tracing',\n      )} to track the performance of your application?`,\n      enabledHint: 'recommended',\n    },\n    {\n      id: 'replay',\n      prompt: `Do you want to enable ${chalk.bold(\n        'Session Replay',\n      )} to get a video-like reproduction of errors during a user session?`,\n      enabledHint: 'recommended, but increases bundle size',\n    },\n  ] as const);\n\n  if (viteConfig) {\n    await traceStep(\n      'Update vite configuration for sourcemap uploads',\n      async () => {\n        try {\n          await configureVitePlugin({\n            orgSlug: selectedProject.organization.slug,\n            projectSlug: selectedProject.slug,\n            url: sentryUrl,\n            selfHosted,\n            authToken,\n          });\n        } catch (e) {\n          clack.log\n            .warn(`Could not update vite configuration to generate and upload sourcemaps.\n    Please update your vite configuration manually using instructions from https://docs.sentry.io/platforms/javascript/guides/remix/sourcemaps/`);\n          debug(e);\n        }\n      },\n    );\n  } else {\n    await traceStep('Update build script for sourcemap uploads', async () => {\n      try {\n        await updateBuildScript({\n          org: selectedProject.organization.slug,\n          project: selectedProject.slug,\n          url: sentryUrl === DEFAULT_URL ? undefined : sentryUrl,\n          isHydrogen: isHydrogenApp(packageJson),\n        });\n\n        await addSentryCliConfig({ authToken }, rcCliSetupConfig);\n      } catch (e) {\n        clack.log\n          .warn(`Could not update build script to generate and upload sourcemaps.\n  Please update your build script manually using instructions from https://docs.sentry.io/platforms/javascript/guides/remix/sourcemaps/`);\n        debug(e);\n      }\n    });\n  }\n\n  await traceStep('Instrument root route', async () => {\n    try {\n      await instrumentRootRoute(isV2, isTS);\n    } catch (e) {\n      clack.log.warn(`Could not instrument root route.\n  Please do it manually using instructions from https://docs.sentry.io/platforms/javascript/guides/remix/manual-setup/`);\n      debug(e);\n    }\n  });\n\n  traceStep('Reveal missing entry files', () => {\n    try {\n      runRemixReveal(isTS);\n    } catch (e) {\n      clack.log.warn(`Could not run 'npx remix reveal'.\n  Please create your entry files manually`);\n      debug(e);\n    }\n  });\n\n  await traceStep('Initialize Sentry on client entry', async () => {\n    try {\n      await initializeSentryOnEntryClient(dsn, isTS, selectedFeatures);\n    } catch (e) {\n      clack.log.warn(`Could not initialize Sentry on client entry.\n  Please do it manually using instructions from https://docs.sentry.io/platforms/javascript/guides/remix/manual-setup/`);\n      debug(e);\n    }\n  });\n\n  let instrumentationFile = '';\n\n  await traceStep('Create server instrumentation file', async () => {\n    try {\n      instrumentationFile = await createServerInstrumentationFile(\n        dsn,\n        selectedFeatures,\n      );\n    } catch (e) {\n      clack.log.warn(\n        'Could not create a server instrumentation file. Please do it manually using instructions from https://docs.sentry.io/platforms/javascript/guides/remix/manual-setup/',\n      );\n      debug(e);\n    }\n  });\n\n  let serverFileInstrumented = false;\n\n  await traceStep(\n    'Create server instrumentation file and import it',\n    async () => {\n      try {\n        serverFileInstrumented = await insertServerInstrumentationFile(\n          dsn,\n          selectedFeatures,\n        );\n      } catch (e) {\n        clack.log.warn(\n          'Could not create a server instrumentation file. Please do it manually using instructions from https://docs.sentry.io/platforms/javascript/guides/remix/manual-setup/',\n        );\n        debug(e);\n      }\n    },\n  );\n\n  if (!serverFileInstrumented && instrumentationFile) {\n    await traceStep(\n      'Update `start` script to import instrumentation file.',\n      async () => {\n        try {\n          await updateStartScript(instrumentationFile);\n        } catch (e) {\n          clack.log\n            .warn(`Could not automatically add Sentry initialization to server entry.\n    Please do it manually using instructions from https://docs.sentry.io/platforms/javascript/guides/remix/manual-setup/`);\n          debug(e);\n        }\n      },\n    );\n  }\n\n  await traceStep('Instrument server `handleError`', async () => {\n    try {\n      await instrumentSentryOnEntryServer(isV2, isTS);\n    } catch (e) {\n      clack.log.warn(`Could not initialize Sentry on server entry.\n  Please do it manually using instructions from https://docs.sentry.io/platforms/javascript/guides/remix/manual-setup/`);\n      debug(e);\n    }\n  });\n\n  const shouldCreateExamplePage = await askShouldCreateExamplePage();\n\n  if (shouldCreateExamplePage) {\n    await traceStep('Create example page', async () => {\n      await createExamplePage({\n        isTS,\n        selfHosted,\n        orgSlug: selectedProject.organization.slug,\n        projectId: selectedProject.id,\n        url: sentryUrl,\n      });\n    });\n  }\n\n  await runPrettierIfInstalled({\n    cwd: undefined,\n  });\n\n  clack.outro(`\n${chalk.green(\n  'Sentry has been successfully configured for your Remix project.',\n)}\n\n${chalk.cyan('You can now deploy your project to see Sentry in action.')}\n\n${chalk.cyan(\n  `To learn more about how to use Sentry with Remix, visit our documentation:\nhttps://docs.sentry.io/platforms/javascript/guides/remix/`,\n)}`);\n}\n"]}