{"version":3,"file":"package-manager.js","sourceRoot":"","sources":["../../../src/utils/package-manager.ts"],"names":[],"mappings":"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","sourcesContent":["import * as fs from 'node:fs';\nimport * as path from 'node:path';\n\nimport * as Sentry from '@sentry/node';\nimport { traceStep } from '../telemetry';\nimport { getPackageDotJson, updatePackageDotJson } from './clack';\n\nexport interface PackageManager {\n  name: string;\n  label: string;\n  installCommand: string;\n  buildCommand: string;\n  /* The command that the package manager uses to run a script from package.json */\n  runScriptCommand: string;\n  flags: string;\n  forceInstallFlag: string;\n  registry?: string;\n  detect: () => boolean;\n  addOverride: (pkgName: string, pkgVersion: string) => Promise<void>;\n}\n\nexport const BUN: PackageManager = {\n  name: 'bun',\n  label: 'Bun',\n  installCommand: 'add',\n  buildCommand: 'bun run build',\n  runScriptCommand: 'bun run',\n  flags: '',\n  forceInstallFlag: '--force',\n  detect: () =>\n    ['bun.lockb', 'bun.lock'].some((lockFile) => {\n      try {\n        return fs.existsSync(path.join(process.cwd(), lockFile));\n      } catch (e) {\n        return false;\n      }\n    }),\n  addOverride: async (pkgName, pkgVersion): Promise<void> => {\n    const packageDotJson = await getPackageDotJson();\n    const overrides = packageDotJson.overrides || {};\n\n    await updatePackageDotJson({\n      ...packageDotJson,\n      overrides: {\n        ...overrides,\n        [pkgName]: pkgVersion,\n      },\n    });\n  },\n};\nexport const DENO: PackageManager = {\n  name: 'deno',\n  label: 'Deno',\n  installCommand: 'install',\n  buildCommand: 'deno task build',\n  runScriptCommand: 'deno task',\n  flags: '',\n  forceInstallFlag: '--force',\n  registry: 'npm',\n  detect: () => {\n    try {\n      return fs.existsSync(path.join(process.cwd(), 'deno.lock'));\n    } catch (e) {\n      return false;\n    }\n  },\n  addOverride: async (pkgName, pkgVersion): Promise<void> => {\n    const packageDotJson = await getPackageDotJson();\n    const overrides = packageDotJson.overrides || {};\n\n    await updatePackageDotJson({\n      ...packageDotJson,\n      overrides: {\n        ...overrides,\n        [pkgName]: pkgVersion,\n      },\n    });\n  },\n};\nexport const YARN_V1: PackageManager = {\n  name: 'yarn',\n  label: 'Yarn V1',\n  installCommand: 'add',\n  buildCommand: 'yarn build',\n  runScriptCommand: 'yarn',\n  flags: '--ignore-workspace-root-check',\n  forceInstallFlag: '--force',\n  detect: () => {\n    try {\n      return fs\n        .readFileSync(path.join(process.cwd(), 'yarn.lock'), 'utf-8')\n        .slice(0, 500)\n        .includes('yarn lockfile v1');\n    } catch (e) {\n      return false;\n    }\n  },\n  addOverride: async (pkgName, pkgVersion): Promise<void> => {\n    const packageDotJson = await getPackageDotJson();\n    const resolutions = packageDotJson.resolutions || {};\n\n    await updatePackageDotJson({\n      ...packageDotJson,\n      resolutions: {\n        ...resolutions,\n        [pkgName]: pkgVersion,\n      },\n    });\n  },\n};\n/** YARN V2/3/4 */\nexport const YARN_V2: PackageManager = {\n  name: 'yarn',\n  label: 'Yarn V2/3/4',\n  installCommand: 'add',\n  buildCommand: 'yarn build',\n  runScriptCommand: 'yarn',\n  flags: '',\n  forceInstallFlag: '--force',\n  detect: () => {\n    try {\n      return fs\n        .readFileSync(path.join(process.cwd(), 'yarn.lock'), 'utf-8')\n        .slice(0, 500)\n        .includes('__metadata');\n    } catch (e) {\n      return false;\n    }\n  },\n  addOverride: async (pkgName, pkgVersion): Promise<void> => {\n    const packageDotJson = await getPackageDotJson();\n    const resolutions = packageDotJson.resolutions || {};\n\n    await updatePackageDotJson({\n      ...packageDotJson,\n      resolutions: {\n        ...resolutions,\n        [pkgName]: pkgVersion,\n      },\n    });\n  },\n};\nexport const PNPM: PackageManager = {\n  name: 'pnpm',\n  label: 'PNPM',\n  installCommand: 'add',\n  buildCommand: 'pnpm build',\n  runScriptCommand: 'pnpm',\n  flags: '--ignore-workspace-root-check',\n  forceInstallFlag: '--force',\n  detect: () => {\n    try {\n      return fs.existsSync(path.join(process.cwd(), 'pnpm-lock.yaml'));\n    } catch (e) {\n      return false;\n    }\n  },\n  addOverride: async (pkgName, pkgVersion): Promise<void> => {\n    const packageDotJson = await getPackageDotJson();\n    const pnpm = packageDotJson.pnpm || {};\n    const overrides = pnpm.overrides || {};\n\n    await updatePackageDotJson({\n      ...packageDotJson,\n      pnpm: {\n        ...pnpm,\n        overrides: {\n          ...overrides,\n          [pkgName]: pkgVersion,\n        },\n      },\n    });\n  },\n};\nexport const NPM: PackageManager = {\n  name: 'npm',\n  label: 'NPM',\n  installCommand: 'install',\n  buildCommand: 'npm run build',\n  runScriptCommand: 'npm run',\n  flags: '',\n  forceInstallFlag: '--force',\n  detect: () => {\n    try {\n      return fs.existsSync(path.join(process.cwd(), 'package-lock.json'));\n    } catch (e) {\n      return false;\n    }\n  },\n  addOverride: async (pkgName, pkgVersion): Promise<void> => {\n    const packageDotJson = await getPackageDotJson();\n    const overrides = packageDotJson.overrides || {};\n\n    await updatePackageDotJson({\n      ...packageDotJson,\n      overrides: {\n        ...overrides,\n        [pkgName]: pkgVersion,\n      },\n    });\n  },\n};\n\nexport const packageManagers = [NPM, YARN_V1, YARN_V2, PNPM, BUN, DENO];\n\n/**\n * Exported only for testing.\n * DO NOT call this function directly!\n * Use `getPackageManger` instead.\n */\nexport function _detectPackageManger(\n  managers?: PackageManager[],\n): PackageManager | null {\n  return traceStep('detect-package-manager', () => {\n    const foundPackageMangers = (managers ?? packageManagers).filter(\n      (packageManager) => packageManager.detect(),\n    );\n\n    // Only consider a package manager detected if we found exactly one.\n    // If we find more than one, we should not make any assumptions.\n    if (foundPackageMangers.length === 1) {\n      Sentry.setTag('package-manager', foundPackageMangers[0].name);\n      return foundPackageMangers[0];\n    }\n\n    Sentry.setTag('package-manager', 'not-detected');\n    return null;\n  });\n}\n"]}