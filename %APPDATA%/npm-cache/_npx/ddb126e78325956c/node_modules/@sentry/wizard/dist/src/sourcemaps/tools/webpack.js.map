{"version":3,"file":"webpack.js","sourceRoot":"","sources":["../../../../src/sourcemaps/tools/webpack.ts"],"names":[],"mappings":"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","sourcesContent":["import * as path from 'node:path';\nimport * as fs from 'node:fs';\n\n// @ts-expect-error - clack is ESM and TS complains about that. It works though\nimport * as clack from '@clack/prompts';\nimport chalk from 'chalk';\n\nimport * as recast from 'recast';\nimport x = recast.types;\nimport t = x.namedTypes;\n\nimport * as Sentry from '@sentry/node';\n\nimport {\n  abortIfCancelled,\n  addDotEnvSentryBuildPluginFile,\n  askForToolConfigPath,\n  createNewConfigFile,\n  getPackageDotJson,\n  installPackage,\n  makeCodeSnippet,\n  showCopyPasteInstructions,\n} from '../../utils/clack';\nimport { hasPackageInstalled } from '../../utils/package-json';\n\nimport type {\n  SourceMapUploadToolConfigurationFunction,\n  SourceMapUploadToolConfigurationOptions,\n} from './types';\n\nimport { findFile, hasSentryContent } from '../../utils/ast-utils';\nimport { debug } from '../../utils/debug';\n\nconst getCodeSnippet = (\n  options: SourceMapUploadToolConfigurationOptions,\n  colors: boolean,\n) =>\n  makeCodeSnippet(colors, (unchanged, plus) =>\n    unchanged(`${plus(\n      'const { sentryWebpackPlugin } = require(\"@sentry/webpack-plugin\");',\n    )}\n\nmodule.exports = {\n  // ... other options\n  ${plus('devtool: \"source-map\", // Source map generation must be turned on')}\n  plugins: [\n    // Put the Sentry Webpack plugin after all other plugins\n    ${plus(`sentryWebpackPlugin({\n      authToken: process.env.SENTRY_AUTH_TOKEN,\n      org: \"${options.orgSlug}\",\n      project: \"${options.projectSlug}\",${\n      options.selfHosted ? `\\n      url: \"${options.url}\",` : ''\n    }\n    }),`)}\n  ],\n}`),\n  );\n\nexport const configureWebPackPlugin: SourceMapUploadToolConfigurationFunction =\n  async (options) => {\n    await installPackage({\n      packageName: '@sentry/webpack-plugin',\n      alreadyInstalled: hasPackageInstalled(\n        '@sentry/webpack-plugin',\n        await getPackageDotJson(),\n      ),\n    });\n\n    const webpackConfigPath =\n      findFile(path.resolve(process.cwd(), 'webpack.config')) ??\n      (await askForToolConfigPath('Webpack', 'webpack.config.js'));\n\n    let successfullyAdded = false;\n    if (webpackConfigPath) {\n      successfullyAdded = await modifyWebpackConfig(webpackConfigPath, options);\n    } else {\n      successfullyAdded = await createNewConfigFile(\n        path.join(process.cwd(), 'webpack.config.js'),\n        getCodeSnippet(options, false),\n        'More information about Webpack configs: https://vitejs.dev/config/',\n      );\n      Sentry.setTag(\n        'created-new-config',\n        successfullyAdded ? 'success' : 'fail',\n      );\n    }\n\n    if (successfullyAdded) {\n      clack.log.info(\n        `We recommend checking the ${\n          webpackConfigPath ? 'modified' : 'added'\n        } file after the wizard finished to ensure it works with your build setup.`,\n      );\n\n      Sentry.setTag('ast-mod', 'success');\n    } else {\n      Sentry.setTag('ast-mod', 'fail');\n      await showCopyPasteInstructions({\n        filename: path.basename(webpackConfigPath || 'webpack.config.js'),\n        codeSnippet: getCodeSnippet(options, true),\n      });\n    }\n\n    await addDotEnvSentryBuildPluginFile(options.authToken);\n  };\n\n/**\n * Modifies a webpack config file to enable source map generation and add the Sentry webpack plugin\n * exported only for testing\n */\nexport async function modifyWebpackConfig(\n  webpackConfigPath: string,\n  options: SourceMapUploadToolConfigurationOptions,\n): Promise<boolean> {\n  try {\n    const webpackConfig = await fs.promises.readFile(webpackConfigPath, {\n      encoding: 'utf-8',\n    });\n\n    const prettyConfigFilename = chalk.cyan(path.basename(webpackConfigPath));\n\n    // no idea why recast returns any here, this is dumb :/\n    // eslint-disable-next-line @typescript-eslint/no-unsafe-member-access\n    const program = recast.parse(webpackConfig.toString()).program as t.Program;\n\n    if (!(await shouldModifyWebpackConfig(program, prettyConfigFilename))) {\n      // Sentry tag is set in shouldModifyWebpackConfig\n      return false;\n    }\n\n    const exportStmt = getCjsModuleExports(program);\n    if (!exportStmt) {\n      // We only care about CJS at the moment since it's probably the most widely used format for webpack configs.\n      debug(`Could not find module.exports = {...} in ${webpackConfigPath}.`);\n      Sentry.setTag('ast-mod-fail-reason', 'config-object-not-found');\n      return false;\n    }\n\n    const configObject = getWebpackConfigObject(exportStmt, program);\n\n    if (!configObject) {\n      debug(`Couldn't find config object in ${webpackConfigPath}`);\n      Sentry.setTag('ast-mod-fail-reason', 'config-object-not-found');\n      return false;\n    }\n\n    const enabledSourcemaps = enableSourcemapsGeneration(configObject);\n\n    if (enabledSourcemaps) {\n      clack.log.success(\n        `Enabled source map generation in ${prettyConfigFilename}.`,\n      );\n    } else {\n      clack.log.warn(\n        `Couldn't enable source maps generation in ${prettyConfigFilename} Please follow the instructions below.`,\n      );\n      Sentry.setTag('ast-mod-fail-reason', 'insertion-fail');\n      return false;\n    }\n\n    const addedPlugin = addSentryWebpackPlugin(program, configObject, options);\n    if (addedPlugin) {\n      clack.log.success(\n        `Added Sentry webpack plugin to ${prettyConfigFilename}.`,\n      );\n    } else {\n      clack.log.warn(\n        `Couldn't add Sentry webpack plugin to ${prettyConfigFilename}. Please follow the instructions below.`,\n      );\n      Sentry.setTag('ast-mod-fail-reason', 'insertion-fail');\n      return false;\n    }\n\n    const code = recast.print(program).code;\n    await fs.promises.writeFile(webpackConfigPath, code);\n\n    return true;\n  } catch (e) {\n    Sentry.setTag('ast-mod-fail-reason', 'insertion-fail');\n    debug(e);\n    return false;\n  }\n}\n\nasync function shouldModifyWebpackConfig(\n  program: t.Program,\n  prettyConfigFilename: string,\n) {\n  if (hasSentryContent(program)) {\n    const shouldContinue = await abortIfCancelled(\n      clack.select({\n        message: `Seems like ${prettyConfigFilename} already contains Sentry-related code. Should the wizard modify it anyway?`,\n        options: [\n          {\n            label: 'Yes, add the Sentry Webpack plugin',\n            value: true,\n          },\n          {\n            label: 'No, show me instructions to manually add the plugin',\n            value: false,\n          },\n        ],\n        initialValue: true,\n      }),\n    );\n\n    if (!shouldContinue) {\n      Sentry.setTag('ast-mod-fail-reason', 'has-sentry-content');\n      return false;\n    }\n  }\n\n  return true;\n}\n\nfunction addSentryWebpackPlugin(\n  program: t.Program,\n  configObj: t.ObjectExpression,\n  options: SourceMapUploadToolConfigurationOptions,\n) {\n  const b = addSentryWebpackPluginImport(program);\n\n  const sentryPluginCall = b.callExpression(\n    b.identifier('sentryWebpackPlugin'),\n    [\n      b.objectExpression([\n        b.objectProperty(\n          b.identifier('authToken'),\n          b.identifier('process.env.SENTRY_AUTH_TOKEN'),\n        ),\n        b.objectProperty(b.identifier('org'), b.stringLiteral(options.orgSlug)),\n        b.objectProperty(\n          b.identifier('project'),\n          b.stringLiteral(options.projectSlug),\n        ),\n        ...(options.selfHosted\n          ? [\n              b.objectProperty(\n                b.identifier('url'),\n                b.stringLiteral(options.url),\n              ),\n            ]\n          : []),\n      ]),\n    ],\n  );\n\n  const pluginsProp = configObj.properties.find(\n    (p): p is t.Property =>\n      p.type === 'Property' &&\n      p.key.type === 'Identifier' &&\n      p.key.name === 'plugins',\n  );\n\n  if (pluginsProp) {\n    if (pluginsProp.value.type === 'ArrayExpression') {\n      pluginsProp.value.elements.push(sentryPluginCall);\n    } else {\n      pluginsProp.value = b.arrayExpression([sentryPluginCall]);\n    }\n    return true;\n  }\n\n  configObj.properties.push(\n    b.objectProperty(\n      b.identifier('plugins'),\n      b.arrayExpression([sentryPluginCall]),\n    ),\n  );\n\n  return true;\n}\n\nfunction addSentryWebpackPluginImport(program: t.Program) {\n  const b = recast.types.builders;\n\n  const sentryPluginRequireStmt = b.variableDeclaration('const', [\n    b.variableDeclarator(\n      b.objectPattern([\n        b.objectProperty.from({\n          key: b.identifier('sentryWebpackPlugin'),\n          value: b.identifier('sentryWebpackPlugin'),\n          shorthand: true,\n        }),\n      ]),\n      b.callExpression(b.identifier('require'), [\n        b.stringLiteral('@sentry/webpack-plugin'),\n      ]),\n    ),\n  ]);\n\n  program.body.unshift(sentryPluginRequireStmt);\n  return b;\n}\n\nfunction enableSourcemapsGeneration(configObj: t.ObjectExpression): boolean {\n  const b = recast.types.builders;\n\n  const devtoolProp = configObj.properties.find(\n    (p): p is t.Property =>\n      p.type === 'Property' &&\n      p.key.type === 'Identifier' &&\n      p.key.name === 'devtool',\n  );\n\n  if (devtoolProp) {\n    // devtool can have quite a lot of source maps values.\n    // see: https://webpack.js.org/configuration/devtool/#devtool\n    // For Sentry to work best, we should set it to \"source-map\" or \"hidden-source-map\"\n    // Heuristic:\n    // - all values that contain \"hidden\" will be set to \"hidden-source-map\"\n    // - all other values will be set to \"source-map\"\n    if (\n      (devtoolProp.value.type === 'Literal' ||\n        devtoolProp.value.type === 'StringLiteral') &&\n      devtoolProp.value.value?.toString().startsWith('hidden-')\n    ) {\n      devtoolProp.value = b.stringLiteral('hidden-source-map');\n    } else {\n      devtoolProp.value = b.stringLiteral('source-map');\n    }\n    return true;\n  }\n\n  configObj.properties.push(\n    b.objectProperty(b.identifier('devtool'), b.stringLiteral('source-map')),\n  );\n\n  return true;\n}\n\nfunction getWebpackConfigObject(\n  moduleExports: t.AssignmentExpression,\n  program: t.Program,\n): t.ObjectExpression | undefined {\n  const rhs = moduleExports.right;\n  if (rhs.type === 'ObjectExpression') {\n    return rhs;\n  }\n  if (rhs.type === 'Identifier') {\n    const configId = rhs.name;\n\n    const configDeclaration = program.body.find(\n      (s): s is t.VariableDeclaration =>\n        s.type === 'VariableDeclaration' &&\n        !!s.declarations.find(\n          (d) =>\n            d.type === 'VariableDeclarator' &&\n            d.id.type === 'Identifier' &&\n            d.id.name === configId,\n        ),\n    );\n\n    const declarator = configDeclaration?.declarations.find(\n      (d): d is t.VariableDeclarator =>\n        d.type === 'VariableDeclarator' &&\n        d.id.type === 'Identifier' &&\n        d.id.name === configId,\n    );\n\n    return declarator?.init?.type === 'ObjectExpression'\n      ? declarator.init\n      : undefined;\n  }\n\n  return undefined;\n}\n\nfunction getCjsModuleExports(\n  program: t.Program,\n): t.AssignmentExpression | undefined {\n  const moduleExports = program.body.find(\n    (s): s is t.ExpressionStatement =>\n      s.type === 'ExpressionStatement' &&\n      s.expression.type === 'AssignmentExpression' &&\n      s.expression.left.type === 'MemberExpression' &&\n      s.expression.left.object.type === 'Identifier' &&\n      s.expression.left.object.name === 'module' &&\n      s.expression.left.property.type === 'Identifier' &&\n      s.expression.left.property.name === 'exports',\n  );\n  return moduleExports?.expression as t.AssignmentExpression;\n}\n"]}