{"version":3,"file":"expo.js","sourceRoot":"","sources":["../../../src/react-native/expo.ts"],"names":[],"mappings":";;;;;;;;;;;;;;;;;;;;;;;;;;;;;AAAA,+EAA+E;AAC/E,sDAAwC;AACxC,kDAA0B;AAC1B,uCAAyB;AACzB,2BAAyB;AAEzB,yCAA8C;AAC9C,qDAAuC;AACvC,0CAA4E;AAE5E,4CAAyC;AAE5B,QAAA,uBAAuB,GAAG,2BAA2B,CAAC;AACtD,QAAA,kCAAkC,GAAG,aAAa,CAAC;AAEnD,QAAA,2BAA2B,GAAG,YAAY,CAAC;AAExD,MAAM,eAAe,GAAG,UAAU,CAAC;AAQnC,SAAgB,6BAA6B;IAC3C,KAAK,CAAC,KAAK,CACT,cAAc,eAAK,CAAC,IAAI,CACtB,aAAa,CACd,iFAAiF,eAAK,CAAC,IAAI,CAC1F,sEAAsE,CACvE,EAAE,CACJ,CAAC;AACJ,CAAC;AARD,sEAQC;AAED;;GAEG;AACI,KAAK,UAAU,kBAAkB,CAAC,OAAgC;IACvE,SAAS,gBAAgB;QACvB,OAAO,IAAA,iCAAyB,EAAC;YAC/B,QAAQ,EAAE,eAAe;YACzB,WAAW,EAAE,iCAAiC,CAAC,OAAO,CAAC;YACvD,IAAI,EAAE,kEAAkE;SACzE,CAAC,CAAC;IACL,CAAC;IAED,MAAM,mBAAmB,GAAG,EAAE,CAAC,UAAU,CAAC,eAAe,CAAC,CAAC;IAE3D,MAAM,CAAC,MAAM,CACX,wBAAwB,EACxB,mBAAmB,CAAC,CAAC,CAAC,OAAO,CAAC,CAAC,CAAC,WAAW,CAC5C,CAAC;IACF,IAAI,CAAC,mBAAmB,EAAE;QACxB,OAAO,MAAM,gBAAgB,EAAE,CAAC;KACjC;IAED,MAAM,OAAO,GAAG,MAAM,kBAAkB,CAAC,eAAe,EAAE,OAAO,CAAC,CAAC;IACnE,IAAI,CAAC,OAAO,EAAE;QACZ,OAAO,MAAM,gBAAgB,EAAE,CAAC;KACjC;AACH,CAAC;AAvBD,gDAuBC;AAED,KAAK,UAAU,kBAAkB,CAC/B,IAAY,EACZ,OAAgC;IAEhC,MAAM,gBAAgB,GAAG,CACvB,MAAM,EAAE,CAAC,QAAQ,CAAC,QAAQ,CAAC,IAAI,EAAE,EAAE,QAAQ,EAAE,OAAO,EAAE,CAAC,CACxD,CAAC,QAAQ,EAAE,CAAC;IACb,MAAM,cAAc,GAAG,IAAA,qBAAS,EAAC,uBAAuB,EAAE,GAAG,EAAE,CAC7D,4BAA4B,CAAC,gBAAgB,EAAE,OAAO,CAAC,CACxD,CAAC;IACF,IAAI,cAAc,KAAK,IAAI,EAAE;QAC3B,OAAO,KAAK,CAAC;KACd;IAED,IAAI;QACF,MAAM,EAAE,CAAC,QAAQ,CAAC,SAAS,CAAC,IAAI,EAAE,cAAc,CAAC,CAAC;KACnD;IAAC,OAAO,KAAK,EAAE;QACd,MAAM,CAAC,MAAM,CAAC,wBAAwB,EAAE,kBAAkB,CAAC,CAAC;QAC5D,KAAK,CAAC,GAAG,CAAC,KAAK,CAAC,mBAAmB,eAAK,CAAC,IAAI,CAAC,iBAAiB,CAAC,GAAG,CAAC,CAAC;QACrE,OAAO,KAAK,CAAC;KACd;IACD,MAAM,CAAC,MAAM,CAAC,wBAAwB,EAAE,oBAAoB,CAAC,CAAC;IAC9D,KAAK,CAAC,GAAG,CAAC,OAAO,CACf,+BAA+B,eAAK,CAAC,IAAI,CAAC,iBAAiB,CAAC,GAAG,CAChE,CAAC;IACF,OAAO,IAAI,CAAC;AACd,CAAC;AAED,SAAgB,4BAA4B,CAC1C,gBAAwB,EACxB,OAAgC;IAEhC,IAAI;QACF,mEAAmE;QACnE,MAAM,eAAe,GAAkB,IAAI,CAAC,KAAK,CAAC,gBAAgB,CAAC,CAAC;QACpE,MAAM,kBAAkB,GACtB,gBAAgB,CAAC,QAAQ,CAAC,+BAAuB,CAAC;YAClD,gBAAgB,CAAC,QAAQ,CAAC,0CAAkC,CAAC,CAAC;QAEhE,IAAI,kBAAkB,EAAE;YACtB,MAAM,CAAC,MAAM,CAAC,wBAAwB,EAAE,iBAAiB,CAAC,CAAC;YAC3D,KAAK,CAAC,GAAG,CAAC,IAAI,CACZ,QAAQ,eAAK,CAAC,IAAI,CAChB,iBAAiB,CAClB,2CAA2C,CAC7C,CAAC;YACF,OAAO,IAAI,CAAC;SACb;QAED,IACE,eAAe,CAAC,IAAI,KAAK,SAAS;YAClC,CAAC,IAAA,qBAAa,EAAC,eAAe,CAAC,IAAI,CAAC,EACpC;YACA,MAAM,CAAC,MAAM,CAAC,wBAAwB,EAAE,cAAc,CAAC,CAAC;YACxD,OAAO,IAAI,CAAC;SACb;QACD,IACE,eAAe,CAAC,IAAI;YACpB,eAAe,CAAC,IAAI,CAAC,OAAO,KAAK,SAAS;YAC1C,CAAC,KAAK,CAAC,OAAO,CAAC,eAAe,CAAC,IAAI,CAAC,OAAO,CAAC,EAC5C;YACA,MAAM,CAAC,MAAM,CAAC,wBAAwB,EAAE,cAAc,CAAC,CAAC;YACxD,OAAO,IAAI,CAAC;SACb;QAED,eAAe,CAAC,IAAI,GAAG,eAAe,CAAC,IAAI,IAAI,EAAE,CAAC;QAClD,eAAe,CAAC,IAAI,CAAC,OAAO,GAAG,eAAe,CAAC,IAAI,CAAC,OAAO,IAAI,EAAE,CAAC;QAClE,eAAe,CAAC,IAAI,CAAC,OAAO,CAAC,IAAI,CAAC;YAChC,+BAAuB;YACvB;gBACE,GAAG,EAAE,OAAO,CAAC,GAAG;gBAChB,OAAO,EAAE,OAAO,CAAC,OAAO;gBACxB,YAAY,EAAE,OAAO,CAAC,GAAG;aAC1B;SACF,CAAC,CAAC;QAEH,OAAO,IAAI,CAAC,SAAS,CAAC,eAAe,EAAE,IAAI,EAAE,CAAC,CAAC,GAAG,QAAG,CAAC;KACvD;IAAC,OAAO,KAAK,EAAE;QACd,MAAM,CAAC,MAAM,CAAC,wBAAwB,EAAE,cAAc,CAAC,CAAC;QACxD,KAAK,CAAC,GAAG,CAAC,KAAK,CACb,wBAAwB,eAAK,CAAC,IAAI,CAChC,iBAAiB,CAClB,oCAAoC,CACtC,CAAC;QACF,OAAO,IAAI,CAAC;KACb;AACH,CAAC;AA1DD,oEA0DC;AAED,SAAgB,iCAAiC,CAAC,EAChD,GAAG,EACH,OAAO,EACP,GAAG,GACwC;IAC3C,OAAO,IAAA,uBAAe,EAAC,IAAI,EAAE,CAAC,SAAS,EAAE,IAAI,EAAE,MAAM,EAAE,EAAE;QACvD,OAAO,SAAS,CAAC;;;MAGf,IAAI,CAAC;;;kBAGO,GAAG;sBACC,OAAO;2BACF,GAAG;;MAExB,CAAC;;EAEL,CAAC,CAAC;IACF,CAAC,CAAC,CAAC;AACL,CAAC;AApBD,8EAoBC","sourcesContent":["// @ts-expect-error - clack is ESM and TS complains about that. It works though\nimport * as clack from '@clack/prompts';\nimport chalk from 'chalk';\nimport * as fs from 'fs';\nimport { EOL } from 'os';\n\nimport { isPlainObject } from '@sentry/utils';\nimport * as Sentry from '@sentry/node';\nimport { makeCodeSnippet, showCopyPasteInstructions } from '../utils/clack';\nimport { RNCliSetupConfigContent } from './react-native-wizard';\nimport { traceStep } from '../telemetry';\n\nexport const SENTRY_EXPO_PLUGIN_NAME = '@sentry/react-native/expo';\nexport const DEPRECATED_SENTRY_EXPO_PLUGIN_NAME = 'sentry-expo';\n\nexport const SENTRY_PLUGIN_FUNCTION_NAME = 'withSentry';\n\nconst APP_CONFIG_JSON = `app.json`;\n\nexport interface AppConfigJson {\n  expo?: {\n    plugins?: Array<[string, undefined | Record<string, unknown>]>;\n  };\n}\n\nexport function printSentryExpoMigrationOutro(): void {\n  clack.outro(\n    `Deprecated ${chalk.cyan(\n      'sentry-expo',\n    )} package installed in your dependencies. Please follow the migration guide at ${chalk.cyan(\n      'https://docs.sentry.io/platforms/react-native/migration/sentry-expo/',\n    )}`,\n  );\n}\n\n/**\n * Finds app.json in the project root and add Sentry Expo `withSentry` plugin.\n */\nexport async function patchExpoAppConfig(options: RNCliSetupConfigContent) {\n  function showInstructions() {\n    return showCopyPasteInstructions({\n      filename: APP_CONFIG_JSON,\n      codeSnippet: getSentryAppConfigJsonCodeSnippet(options),\n      hint: 'This ensures auto upload of source maps during native app build.',\n    });\n  }\n\n  const appConfigJsonExists = fs.existsSync(APP_CONFIG_JSON);\n\n  Sentry.setTag(\n    'app-config-file-status',\n    appConfigJsonExists ? 'found' : 'not-found',\n  );\n  if (!appConfigJsonExists) {\n    return await showInstructions();\n  }\n\n  const patched = await patchAppConfigJson(APP_CONFIG_JSON, options);\n  if (!patched) {\n    return await showInstructions();\n  }\n}\n\nasync function patchAppConfigJson(\n  path: string,\n  options: RNCliSetupConfigContent,\n): Promise<boolean> {\n  const appConfigContent = (\n    await fs.promises.readFile(path, { encoding: 'utf-8' })\n  ).toString();\n  const patchedContent = traceStep('app-config-json-patch', () =>\n    addWithSentryToAppConfigJson(appConfigContent, options),\n  );\n  if (patchedContent === null) {\n    return false;\n  }\n\n  try {\n    await fs.promises.writeFile(path, patchedContent);\n  } catch (error) {\n    Sentry.setTag('app-config-file-status', 'json-write-error');\n    clack.log.error(`Unable to write ${chalk.cyan('app.config.json')}.`);\n    return false;\n  }\n  Sentry.setTag('app-config-file-status', 'json-write-success');\n  clack.log.success(\n    `Added Sentry Expo plugin to ${chalk.cyan('app.config.json')}.`,\n  );\n  return true;\n}\n\nexport function addWithSentryToAppConfigJson(\n  appConfigContent: string,\n  options: RNCliSetupConfigContent,\n): string | null {\n  try {\n    // eslint-disable-next-line @typescript-eslint/no-unsafe-assignment\n    const parsedAppConfig: AppConfigJson = JSON.parse(appConfigContent);\n    const includesWithSentry =\n      appConfigContent.includes(SENTRY_EXPO_PLUGIN_NAME) ||\n      appConfigContent.includes(DEPRECATED_SENTRY_EXPO_PLUGIN_NAME);\n\n    if (includesWithSentry) {\n      Sentry.setTag('app-config-file-status', 'already-patched');\n      clack.log.warn(\n        `Your ${chalk.cyan(\n          'app.config.json',\n        )} already includes the Sentry Expo plugin.`,\n      );\n      return null;\n    }\n\n    if (\n      parsedAppConfig.expo !== undefined &&\n      !isPlainObject(parsedAppConfig.expo)\n    ) {\n      Sentry.setTag('app-config-file-status', 'invalid-json');\n      return null;\n    }\n    if (\n      parsedAppConfig.expo &&\n      parsedAppConfig.expo.plugins !== undefined &&\n      !Array.isArray(parsedAppConfig.expo.plugins)\n    ) {\n      Sentry.setTag('app-config-file-status', 'invalid-json');\n      return null;\n    }\n\n    parsedAppConfig.expo = parsedAppConfig.expo ?? {};\n    parsedAppConfig.expo.plugins = parsedAppConfig.expo.plugins ?? [];\n    parsedAppConfig.expo.plugins.push([\n      SENTRY_EXPO_PLUGIN_NAME,\n      {\n        url: options.url,\n        project: options.project,\n        organization: options.org,\n      },\n    ]);\n\n    return JSON.stringify(parsedAppConfig, null, 2) + EOL;\n  } catch (error) {\n    Sentry.setTag('app-config-file-status', 'invalid-json');\n    clack.log.error(\n      `Unable to parse your ${chalk.cyan(\n        'app.config.json',\n      )}. Make sure it has a valid format!`,\n    );\n    return null;\n  }\n}\n\nexport function getSentryAppConfigJsonCodeSnippet({\n  url,\n  project,\n  org,\n}: Omit<RNCliSetupConfigContent, 'authToken'>) {\n  return makeCodeSnippet(true, (unchanged, plus, _minus) => {\n    return unchanged(`{\n  \"name\": \"my app\",\n  \"plugins\": [\n    ${plus(`[\n      \"@sentry/react-native/expo\",\n      {\n        \"url\": \"${url}\",\n        \"project\": \"${project}\",\n        \"organization\": \"${org}\"\n      }\n    ]`)}\n  ],\n}`);\n  });\n}\n"]}